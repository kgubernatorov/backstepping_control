# Two-wheeled differential drive robot backstepping control

## Overview

This project implements backstepping control for a two-wheeled differential drive robot. The robot follows a trajectory generated by artificial potential fields (APF), which guide it to the goal while avoiding obstacles. The robot's motion is subject to both longitudinal and lateral slippages, and control is achieved by regulating the torques of two DC motors (one per wheel). The code provides both a PD controller and a backstepping controller for comparison.

---

## Task Definition

- **Given:**
The robot is provided with a trajectory generated by artificial potential fields, which account for the goal, obstacles (including moving ones), and workspace boundaries.
- **Achieved:**
The robot's linear speed, acceleration, angular speed, and angular acceleration are controlled. The control is based on the torque derivative equations of DC motors, with both motors (left and right wheels) controlled simultaneously. The robot's movement is affected by random longitudinal and lateral slippages, making the control task more realistic and challenging.

---

## Mathematic Model

### Robot Kinematics and Dynamics

The robot's state is $(x, y, \theta)$, where:

- $x, y$: Position in the plane
- $\theta$: Heading angle

The robot's update with slippage is:

$$
\begin{align*}
v &= v_\text{cmd} - \mu v_\text{cmd} \cdot dt + \text{slip}_v \\
\omega &= \omega_\text{cmd} - \mu_\omega \omega_\text{cmd} \cdot dt + \text{slip}_\omega \\
dx &= v \cos(\theta) \cdot dt \\
dy &= v \sin(\theta) \cdot dt \\
d\theta &= \omega \cdot dt \\
\end{align*}
$$

where:

- $v_\text{cmd}, \omega_\text{cmd}$: Commanded linear and angular velocities
- $\mu, \mu_\omega$: Slippage coefficients
- $\text{slip}_v, \text{slip}_\omega$: Gaussian random slippage
- $dt$: Time step


### Speed Smoothing

To avoid abrupt changes in speed:

$$
v_\text{cmd} =
\begin{cases}
\min(v_\text{cmd} + a, v_\text{desired}) & \text{if } v_\text{cmd} < v_\text{desired} \\
\max(v_\text{cmd} - a, v_\text{desired}) & \text{otherwise}
\end{cases}
$$

where $a$ is the acceleration increment.

### Robot and Motor Parameters

- $m$: Robot mass (2.0 kg)
- $r$: Wheel radius (0.05 m)
- $w$: Wheelbase (0.2 m)
- $\gamma$: Motor time constant (0.15 s) - this defines how quickly the motor torque responds to the control input.


### Motor Dynamics

Each motor torque follows first-order lag dynamics:

$$
\dot{\tau}_L = \gamma (\tau_{L,\text{des}} - \tau_L)
$$

$$
\dot{\tau}_R = \gamma (\tau_{R,\text{des}} - \tau_R)
$$

where $\tau_{L,R}$ are actual torques, and $\tau_{L,R,\text{des}}$ are desired torques.

---

## Artificial Potential Fields

### Environment Setup

- **Goal:** $(10.0, 0.0)$
- **Start:** Random point in rectangle $(0, -0.5)$ to $(1, 0.5)$
- **Moving Obstacle:** Moves from $(3.0, 0.0)$ to $(8.0, 0.0)$ at constant speed


### Forces

**Attractive Force:**

$$
\mathbf{F}_\text{att} = k_\text{att} (\mathbf{q}_\text{goal} - \mathbf{q}), \quad \|\mathbf{q}_\text{goal} - \mathbf{q}\| \leq r_\text{att}
$$

**Vertical Force:**

$$
F_y =
\begin{cases}
-k_\text{vert} (\mathbf{1} + \mathbf{a}_\text{v} v) |y| & y > 0 \\
k_\text{vert} (\mathbf{1} + \mathbf{a}_\text{v} v) |y| & y < 0 \\
0 & y = 0
\end{cases}
$$

where $k_\text{vert} = k_{\text{vert}0} (1 + \alpha_v v)$

**Horizontal Force:**

$$
F_x = k_\text{horiz} (\mathbf{1} + \mathbf{a}_\text{h} v) \frac{10 - x}{10}
$$

where $k_\text{horiz} = k_{\text{horiz}0} (1 + \alpha_h v)$

**Repulsive Force:**

$$
\mathbf{F}_\text{rep} =
\begin{cases}
k_\text{rep} \left(\frac{1}{d} - \frac{1}{d_0}\right) \frac{\mathbf{q} - \mathbf{q}_o}{d} & d \leq d_0 \\
0 & d > d_0
\end{cases}
$$

where $d = \|\mathbf{q} - \mathbf{q}_o\|$

**Vortex Force:**

$$
\mathbf{F}_\text{vortex} =
\begin{cases}
k_\text{vortex} \frac{\mathbf{p}_\perp}{d^2} & \text{if above obstacle} \\
-k_\text{vortex} \frac{\mathbf{p}_\perp}{d^2} & \text{if below obstacle}
\end{cases}
$$

where $\mathbf{p}_\perp = [y, -x]$

**Variables:**

- $\mathbf{q}$: Robot position
- $\mathbf{q}_\text{goal}$: Goal position
- $\mathbf{q}_o$: Obstacle position
- $k_\text{att}, k_\text{vert}, k_\text{horiz}, k_\text{rep}, k_\text{vortex}$: Field gains
- $d_0$: Repulsion threshold

---

## PD DC Motors Control

### Desired Velocities and Accelerations

From the trajectory:

$$
v_d[i] = \frac{\sqrt{(x_i - x_{i-1})^2 + (y_i - y_{i-1})^2}}{dt}
$$

$$
\theta_d[i] = \arctan2(y_i - y_{i-1}, x_i - x_{i-1})
$$

$$
\omega_d[i] = \frac{\theta_d[i] - \theta_d[i-1]}{dt}
$$

$$
\dot{v}_d[i] = \frac{v_d[i] - v_d[i-1]}{dt}
$$

$$
\dot{\omega}_d[i] = \frac{\omega_d[i] - \omega_d[i-1]}{dt}
$$

### PD Control Law

- **Errors:**

$$
e_v = v - v_\text{ref}
$$

$$
e_\omega = \omega - \omega_\text{ref}
$$

$$
e_{\dot{v}} = \dot{v} - \dot{v}_\text{ref}
$$

$$
e_{\dot{\omega}} = \dot{\omega} - \dot{\omega}_\text{ref}
$$
- **PD control for torque derivatives:**

$$
\tau_\text{sum,des} = -(K_{p,v} e_v + K_{d,v} e_{\dot{v}}) \frac{2m}{r}
$$

$$
\tau_\text{diff,des} = -(K_{p,\omega} e_\omega + K_{d,\omega} e_{\dot{\omega}}) \frac{mw}{r}
$$

$$
\tau_{L,\text{des}} = 0.5 (\tau_\text{sum,des} - \tau_\text{diff,des})
$$

$$
\tau_{R,\text{des}} = 0.5 (\tau_\text{sum,des} + \tau_\text{diff,des})
$$
- **Motor torque update (first-order lag):**

$$
a_L = \gamma (\tau_{L,\text{des}} - \tau_L)
$$

$$
a_R = \gamma (\tau_{R,\text{des}} - \tau_R)
$$

$$
\tau_L \leftarrow \tau_L + dt \cdot \frac{1}{\gamma} (-\tau_L + a_L)
$$

$$
\tau_R \leftarrow \tau_R + dt \cdot \frac{1}{\gamma} (-\tau_R + a_R)
$$
- **Robot acceleration from torques:**

$$
\dot{v} = \frac{r}{2m} (\tau_L + \tau_R)
$$

$$
\dot{\omega} = \frac{r}{mw} (\tau_R - \tau_L)
$$

---

## Backstepping DC Motors Control

### Desired Velocities and Accelerations

Same as in PD control.

### Backstepping Control Law

- **Errors:**

$$
e_v = v - v_\text{ref}
$$

$$
e_\omega = \omega - \omega_\text{ref}
$$

$$
e_{\dot{v}} = \dot{v} - \dot{v}_\text{ref}
$$

$$
e_{\dot{\omega}} = \dot{\omega} - \dot{\omega}_\text{ref}
$$


#### Lyapunov Function: Construction and Explanation

To ensure stability of the closed-loop system using backstepping, we construct a Lyapunov function that penalizes deviations from the desired velocity and acceleration. The Lyapunov function is chosen as the sum of the squared errors for both linear and angular velocities and accelerations:

$$
V = \frac{1}{2} e_v^2 + \frac{1}{2} e_\omega^2 + \frac{1}{2} e_{\dot{v}}^2 + \frac{1}{2} e_{\dot{\omega}}^2
$$

**How this Lyapunov function is constructed:**

- The terms $e_v$ and $e_\omega$ represent the errors between the actual and reference (desired) linear and angular velocities.
- The terms $e_{\dot{v}}$ and $e_{\dot{\omega}}$ represent the errors between the actual and reference (desired) linear and angular accelerations.
- By squaring these errors and summing them, the function $V$ is always non-negative and is minimized (i.e., zero) only when all errors are zero.
- This form is standard in control theory for tracking problems, as it directly quantifies the deviation from the desired trajectory in both velocity and acceleration domains.

The backstepping control law is then designed to ensure that $V$ decreases over time, driving all errors to zero.

**Backstepping Control Law:**

- Compute desired accelerations:

$$
v_\text{dot,des} = \dot{v}_\text{ref} - k_1 e_v
$$

$$
\omega_\text{dot,des} = \dot{\omega}_\text{ref} - k_2 e_\omega
$$
- Convert to desired torques:

$$
\tau_\text{sum,des} = \frac{2m}{r} v_\text{dot,des}
$$

$$
\tau_\text{diff,des} = \frac{mw}{r} \omega_\text{dot,des}
$$

$$
\tau_{L,\text{des}} = 0.5 (\tau_\text{sum,des} - \tau_\text{diff,des})
$$

$$
\tau_{R,\text{des}} = 0.5 (\tau_\text{sum,des} + \tau_\text{diff,des})
$$
- For the motor torque dynamics, the backstepping control includes additional terms:

$$
a_L = \gamma (\tau_{L,\text{des}} - \tau_L) - k_3 e_{\dot{v}}
$$

$$
a_R = \gamma (\tau_{R,\text{des}} - \tau_R) - k_4 e_{\dot{\omega}}
$$
- Update motor torques:

$$
\tau_L \leftarrow \tau_L + dt \cdot \frac{1}{\gamma} (-\tau_L + a_L)
$$

$$
\tau_R \leftarrow \tau_R + dt \cdot \frac{1}{\gamma} (-\tau_R + a_R)
$$
- Update robot velocities and pose as in the PD control.

$$
\dot{v} = \frac{r}{2m} (\tau_L + \tau_R)
$$

$$
\dot{\omega} = \frac{r}{mw} (\tau_R - \tau_L)
$$

$$
v \leftarrow v + \dot{v} \cdot dt
$$

$$
\omega \leftarrow \omega + \dot{\omega} \cdot dt
$$

$$
x \leftarrow x + v \cos(\theta) \cdot dt
$$

$$
y \leftarrow y + v \sin(\theta) \cdot dt
$$

$$
\theta \leftarrow \theta + \omega \cdot dt
$$

## Results

### Robot movement in Artificial Potential Fields

*To be completed.*

### PD control

*To be completed.*

### Backstepping control

*To be completed.*

